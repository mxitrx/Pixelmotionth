<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ระบบเช่าอุปกรณ์</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css" />
    <link rel="stylesheet" href="style.css" />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
</head>

<body class="antialiased">
    <div id="modal" class="modal-overlay">
        <div class="modal-content shadow-xl">
            <div id="loader" class="loader mx-auto hidden"></div>
            <div id="modal-icon" class="text-5xl mb-4"></div>
            <p id="modal-message" class="text-lg font-medium"></p>
        </div>
    </div>
    
    <div id="details-modal" class="modal-overlay">
        <div class="modal-content details-modal-content">
            <div id="details-modal-body" class="details-modal-body">
                <img id="details-image" src="" alt="Equipment Image" class="w-full h-64 object-cover rounded-lg mb-4">
                <h3 id="details-name" class="text-3xl font-bold text-gray-100"></h3>
                <p id="details-price" class="text-xl accent-color font-semibold mt-1"></p>
                <p id="details-desc" class="text-gray-300 mt-4"></p>
            </div>
            <button onclick="hideDetailsModal()"
                class="mt-6 bg-gray-600 text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-500 w-full">ปิด</button>
        </div>
    </div>
    <div id="promptpay-modal" class="modal-overlay">
        <div class="modal-content promptpay-modal-content">
            <h3 class="text-2xl font-bold">สแกนเพื่อชำระเงิน</h3>
            <p class="mb-4">กรุณาชำระเงินภายใน 15 นาที</p>
            <img id="promptpay-qr" src="" alt="PromptPay QR Code" class="w-64 h-64 mx-auto border rounded-lg">
            <p class="mt-4 text-lg">ยอดชำระ: <strong id="promptpay-amount" class="text-orange-600"></strong> บาท</p>
            <button onclick="hidePromptPayModal()"
                class="mt-6 bg-gray-600 text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-500 w-full">ปิดหน้านี้</button>
        </div>
    </div>
    <div id="event-details-modal" class="modal-overlay">
        <div class="modal-content event-details-modal-content">
            <h3 id="event-title" class="text-2xl font-bold accent-color border-b border-gray-600 pb-2 mb-4"></h3>
            <div id="event-body" class="event-details-body text-gray-300 space-y-2">
                <p><i class="fas fa-user"></i><strong class="text-gray-100" id="event-renter"></strong></p>
                <p><i class="fas fa-calendar-alt"></i><span id="event-period"></span></p>
                <p><i class="fas fa-phone"></i>0<span id="event-phone"></span></p>
                <p><i class="fas fa-map-marker-alt"></i><span id="event-address" class="whitespace-pre-wrap"></span></p>
            </div>
            <button onclick="hideEventDetailsModal()" class="mt-6 bg-gray-600 text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-500 w-full">ปิด</button>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl relative">
        <a href="admin.html" class="absolute top-4 right-4 md:top-8 md:right-8 bg-gray-700 text-gray-200 text-sm font-semibold px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2 z-10">
            <i class="fas fa-user-shield"></i> Admin
        </a>
        <header class="text-center mb-10">
            <i class="fas fa-tasks text-4xl accent-color"></i>
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-100 mt-2">Pixelmotionth - เช่าอุปกรณ์</h1>
            <p class="text-gray-400 mt-2 text-base sm:text-lg">เลือกอุปกรณ์และช่วงเวลาที่ต้องการเช่า</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 bg-[#1f2937] border border-gray-700 p-6 rounded-xl shadow-lg">
                <form id="rentalForm" class="space-y-4">
                    <input type="hidden" name="action" value="rent" />
                    <div>
                        <label for="renterName" class="block text-sm font-medium text-gray-400 mb-1">ชื่อผู้เช่า</label>
                        <input type="text" id="renterName" name="renterName" class="form-input" required />
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-400 mb-1">เบอร์โทรศัพท์</label>
                        <input type="tel" id="phone" name="phone" class="form-input" required />
                    </div>
                    <div>
  <label for="email" class="block text-sm font-medium text-gray-400 mb-1">อีเมล (สำหรับรับการยืนยัน)</label>
  <input type="email" id="email" name="email" class="form-input" placeholder="example@email.com" required />
</div>

                     <div>
                        <label for="address" class="block text-sm font-medium text-gray-400 mb-1">ที่อยู่ (สำหรับติดตาม)</label>
                        <textarea id="address" name="address" class="form-input" rows="3" required></textarea>
                    </div>
                    <div>
                        <label for="equipmentName" class="block text-sm font-medium text-gray-400 mb-1">อุปกรณ์</label>
                        <div class="flex items-center gap-4">
                            <select id="equipmentName" name="equipmentName" class="form-input flex-grow" required>
                                <option value="">กำลังโหลด...</option>
                            </select>
                            <div id="equipment-image-preview" class="w-16 h-16 bg-gray-700 rounded-md flex items-center justify-center text-gray-500 flex-shrink-0">
                                <i class="fas fa-image text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-400 mb-1">วันที่เริ่มเช่า</label>
                        <input type="text" id="startDate" name="startDate" class="form-input" placeholder="เลือกวัน" required />
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-400 mb-1">วันที่สิ้นสุด</label>
                        <input type="text" id="endDate" name="endDate" class="form-input" placeholder="เลือกวัน" required />
                    </div>
                    <div id="total-cost-container" class="pt-2 text-center bg-gray-800 p-4 rounded-lg hidden">
                        <p class="text-gray-400 text-sm">ยอดรวมค่าเช่า</p>
                        <p id="total-cost-display" class="text-3xl font-bold accent-color">฿0.00</p>
                    </div>
                    <div class="pt-2">
                        <button type="submit" class="btn-primary w-full flex items-center justify-center">
                            <i class="fas fa-check-circle mr-2"></i>ยืนยันการเช่า
                        </button>
                    </div>
                </form>
            </div>

            <div class="lg:col-span-8">
                <div class="bg-[#1f2937] border border-gray-700 p-4 sm:p-6 rounded-xl shadow-lg mb-8">
                    <div id='calendar'></div> </div>
                <div class="bg-[#1f2937] lg:bg-transparent border border-gray-700 lg:border-none p-6 lg:p-0 rounded-xl shadow-lg lg:shadow-none">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-5">
                        <h2 class="text-2xl font-semibold mb-3 sm:mb-0 flex items-center text-gray-100">
                            <i class="fas fa-clipboard-list mr-3 accent-color"></i>อุปกรณ์ที่กำลังถูกเช่า
                        </h2>
                        <button id="refreshBtn" class="bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-150 ease-in-out flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i>รีเฟรช
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full responsive-table">
                            <thead class="bg-gray-800">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">รูปภาพ</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">อุปกรณ์</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">วันที่เริ่มเช่า</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">วันที่สิ้นสุด</th>
                                </tr>
                            </thead>
                            <tbody id="statusTableBody" class="lg:divide-y lg:divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
<body class="antialiased">
    <div id="modal" class="modal-overlay"> </div>
    <div id="details-modal" class="modal-overlay"> </div>
    <div id="promptpay-modal" class="modal-overlay">
        <div class="modal-content promptpay-modal-content">
            <h3 class="text-2xl font-bold">สแกนเพื่อชำระเงิน</h3>
            <p class="mb-4">กรุณาชำระเงินและอัปโหลดสลิปเพื่อยืนยัน</p>
            <img id="promptpay-qr" src="" alt="PromptPay QR Code" class="w-64 h-64 mx-auto border rounded-lg">
            <p class="mt-4 text-lg">ยอดชำระ: <strong id="promptpay-amount" class="text-orange-600"></strong> บาท</p>
            <button id="upload-slip-btn"
                class="mt-6 bg-orange-600 text-white w-full px-4 py-2 rounded-lg hover:bg-orange-700">ฉันชำระเงินแล้ว (อัปโหลดสลิป)</button>
        </div>
    </div>
    <div id="event-details-modal" class="modal-overlay"> </div>
    <div id="slip-modal" class="modal-overlay">
        <div class="modal-content slip-upload-modal-content">
            <h3 class="text-2xl font-bold text-gray-100 border-b border-gray-600 pb-2 mb-4">ยืนยันการชำระเงิน</h3>
            <p class="text-gray-400 mb-4">กรุณาอัปโหลดสลิปการโอนเงินเพื่อยืนยันรายการเช่าของคุณ</p>
            <form id="slip-form">
                <input type="file" id="slip-upload" class="hidden" accept="image/*">
                <label for="slip-upload" id="upload-label" class="w-full p-6 text-center rounded-lg cursor-pointer block">
                    <img id="slip-preview" class="mx-auto mb-4 hidden rounded" src="#" alt="Slip Preview"/>
                    <i id="upload-icon" class="fas fa-cloud-upload-alt text-4xl text-gray-500"></i>
                    <p id="upload-text" class="text-gray-400 mt-2">คลิกเพื่อเลือกไฟล์สลิป</p>
                </label>
                <div class="mt-6 flex gap-4">
                    <button type="button" onclick="hideSlipModal()" class="w-1/2 bg-gray-600 text-gray-200 py-2 rounded-lg hover:bg-gray-500">ยกเลิก</button>
                    <button type="submit" id="submit-slip-btn" class="w-1/2 btn-primary flex items-center justify-center min-h-[44px]" disabled>
                        <span class="btn-text">ยืนยัน</span>
                        <div class="loader-small hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <footer class="marquee-container">
        <p class="marquee-text accent-color">กรุณาดูแลรักษาอุปกรณ์ที่เช่า และส่งคืนตามกำหนดเวลา... ขอขอบคุณครับ</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>
    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwoSvxVZBC66dFKVipaMwSqO9hB42VchXZG8VuzMheMF99GTxw90DKu0Jvn7WSIUCrN/exec";
        const PROMPTPAY_ID = "0972653945";

        // --- GLOBAL VARIABLES & ELEMENTS ---
        let equipmentDataStore = [];
        const rentalForm = document.getElementById("rentalForm");
        const statusTableBody = document.getElementById("statusTableBody");
        const detailsModal = document.getElementById('details-modal');
        const promptpayModal = document.getElementById('promptpay-modal');
        const eventDetailsModal = document.getElementById('event-details-modal');
        const equipmentSelect = document.getElementById("equipmentName");
        const refreshBtn = document.getElementById("refreshBtn");
        const imagePreview = document.getElementById("equipment-image-preview");
        const totalCostContainer = document.getElementById("total-cost-container");
        const totalCostDisplay = document.getElementById("total-cost-display");
        const modal = document.getElementById("modal");

        let startDatepicker, endDatepicker;
        let calendar;

        // --- CALENDAR FUNCTIONS (เปลี่ยนมาใช้ FullCalendar) ---
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'th',
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                events: async function (fetchInfo, successCallback, failureCallback) {
                    try {
                        const response = await fetch(`${SCRIPT_URL}?action=getEvents`);
                        const eventsData = await response.json();
                        const formattedEvents = eventsData.map(event => ({
                            id: event.id,
                            title: event.title,
                            start: event.start,
                            end: event.end,
                            extendedProps: {
                                body: event.body
                            }
                        }));
                        successCallback(formattedEvents);
                    } catch (error) {
                        console.error('Error fetching calendar events:', error);
                        failureCallback(error);
                    }
                },
                eventClick: function (info) {
                    const eventData = {
                        title: info.event.title,
                        body: info.event.extendedProps.body,
                        start: info.event.start,
                        end: info.event.end
                    };
                    showEventDetailsModal(eventData);
                }
            });
            calendar.render();
        }

        function refreshCalendarEvents() {
            if (calendar) {
                calendar.refetchEvents();
            }
        }

        // --- MODAL FUNCTIONS (เหมือนเดิม) ---
        function showDetailsModal(equipmentName) {
            const equipment = equipmentDataStore.find(item => item.name === equipmentName);
            if (!equipment) return;
            document.getElementById('details-image').src = equipment.imageUrl || 'https://via.placeholder.com/400x300.png?text=No+Image';
            document.getElementById('details-name').textContent = equipment.name;
            document.getElementById('details-price').textContent = `฿${parseFloat(equipment.price).toFixed(2)} / วัน`;
            document.getElementById('details-desc').textContent = equipment.desc || 'ไม่มีคำอธิบายสำหรับอุปกรณ์นี้';
            detailsModal.classList.add('active');
        }
        function hideDetailsModal() { detailsModal.classList.remove('active'); }

        const hideEventDetailsModal = () => eventDetailsModal.classList.remove('active');
        function showEventDetailsModal(event) {
            const { title, body, start, end } = event;
            const renterName = title.split('(')[1]?.replace(')', '') || 'ไม่ระบุ';
            const equipmentName = title.split(' (')[0];
            const phoneMatch = body.match(/เบอร์โทร: (.*)/);
            const addressMatch = body.match(/ที่อยู่: (.*)/);

            document.getElementById('event-title').textContent = equipmentName;
            document.getElementById('event-renter').textContent = renterName;
            document.getElementById('event-phone').textContent = phoneMatch ? phoneMatch[1].trim() : 'ไม่มีข้อมูล';
            document.getElementById('event-address').textContent = addressMatch ? addressMatch[1].trim() : 'ไม่มีข้อมูล';

            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const startDate = new Date(start).toLocaleDateString('th-TH', options);
            const endDate = new Date(end).toLocaleDateString('th-TH', options);
            document.getElementById('event-period').textContent = `${startDate} - ${endDate}`;

            eventDetailsModal.classList.add('active');
        }
        
        function showPromptPayModal(amount) { /* ... โค้ดเดิม ... */ }
        function hidePromptPayModal() { /* ... โค้ดเดิม ... */ }
        function showModal(type, message) { /* ... โค้ดเดิม ... */ }
        function hideModal() { /* ... โค้ดเดิม ... */ }

        // --- DATA FETCHING & DISPLAY (เหมือนเดิม) ---
        async function fetchEquipmentList() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getEquipment`);
    equipmentDataStore = await res.json();

    equipmentSelect.innerHTML = '<option value="">-- เลือกอุปกรณ์ --</option>';

    equipmentDataStore.forEach(eq => {
      // 🔹 ตัดคำ "บาท", "/", "วัน" ออก
      const numericPrice = parseFloat(String(eq.price).replace(/[^\d.]/g, "")) || 0;
      eq.price = numericPrice;

      const opt = document.createElement("option");
      opt.value = eq.name;
      opt.textContent = `${eq.name} (${numericPrice} บาท/วัน)`;
      equipmentSelect.appendChild(opt);
    });
  } catch (err) {
    console.error("Error fetching equipment list:", err);
    equipmentSelect.innerHTML = '<option value="">โหลดไม่สำเร็จ</option>';
  }
}


        async function fetchStatusData() {
    statusTableBody.innerHTML = `
      <tr>
        <td colspan="4" class="text-center p-6 text-gray-400">
          <i class="fas fa-spinner fa-spin mr-2"></i>กำลังโหลด...
        </td>
      </tr>`;

    try {
        const response = await fetch(`${SCRIPT_URL}?action=getLogs`);
        const data = await response.json();

        statusTableBody.innerHTML = "";

        if (data.length === 0) {
            statusTableBody.innerHTML = `
              <tr><td colspan="4" class="text-center p-6 text-gray-500">
                ไม่มีข้อมูลการเช่า
              </td></tr>`;
            return;
        }

        // ✅ แก้ index สถานะเป็น [8]
        const rentedItems = data.filter((rowData) => rowData[8] === "เช่าอยู่");

        if (rentedItems.length === 0) {
            statusTableBody.innerHTML = `
              <tr><td colspan="4" class="text-center p-6 text-gray-500">
                ไม่มีอุปกรณ์ที่กำลังถูกเช่า
              </td></tr>`;
            return;
        }

        rentedItems.forEach((rowData) => {
            const [rowId, ts, renterName, address, phone, equipment, startDate, endDate, status, eventId, totalCost, imageUrl] = rowData;
            const imageTag = imageUrl
                ? `<img src="${imageUrl}" alt="${equipment}" class="w-16 h-16 object-cover rounded-md mx-auto sm:mx-0">`
                : `<div class="w-16 h-16 bg-gray-700 rounded-md flex items-center justify-center text-gray-500">
                    <i class="fas fa-image"></i>
                   </div>`;
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const formattedStartDate = new Date(startDate).toLocaleDateString("th-TH", options);
            const formattedEndDate = new Date(endDate).toLocaleDateString("th-TH", options);

            const row = document.createElement("tr");
            row.innerHTML = `
                <td data-label="รูปภาพ" class="image-cell">${imageTag}</td>
                <td data-label="อุปกรณ์" class="font-semibold text-gray-100">
                    ${equipment}
                    <button onclick="showDetailsModal('${equipment}')" class="ml-2 text-xs text-orange-400 hover:underline block text-left">(ดูรายละเอียด)</button>
                </td>
                <td data-label="วันที่เริ่มเช่า" class="text-gray-300">${formattedStartDate}</td>
                <td data-label="วันที่สิ้นสุด" class="text-gray-300">${formattedEndDate}</td>`;
            statusTableBody.appendChild(row);
        });
    } catch (error) {
        console.error("Error fetching status data:", error);
        statusTableBody.innerHTML = `
          <tr><td colspan="4" class="text-center p-6 text-red-400">
            <i class="fas fa-exclamation-triangle mr-2"></i>เกิดข้อผิดพลาด
          </td></tr>`;
    }
}


        function calculateAndDisplayCost() { /* ... โค้ดเดิม (คำนวณรายวัน) ... */ }
        function updateImagePreview() { /* ... โค้ดเดิม ... */ }

        // --- FORM SUBMISSION (แก้ไขให้ Refresh ปฏิทิน) ---
        rentalForm.addEventListener("submit", async (e) => {
   window.location.href = `payment.html?name=${encodeURIComponent(formData.get("renterName"))}&equipment=${encodeURIComponent(formData.get("equipmentName"))}&amount=${encodeURIComponent(total)}&email=${encodeURIComponent(formData.get("email"))}`;
;

    // ✅ แสดง Loader
    showModal("loading", "กำลังบันทึกข้อมูล...");

    const formData = new FormData(rentalForm);
    if (new Date(formData.get("endDate")) <= new Date(formData.get("startDate"))) {
        showModal("error", "วันที่สิ้นสุดต้องอยู่หลังวันที่เริ่มเช่า");
        return;
    }

    try {
        const response = await fetch(SCRIPT_URL, { method: "POST", body: formData });
        const result = await response.json();
        if (result.result === "success") {
            hideModal();
            const totalCost = parseFloat(document.getElementById('total-cost-display').textContent.replace('฿', ''));
            showPromptPayModal(totalCost);
            rentalForm.reset();
            updateImagePreview();
            calculateAndDisplayCost();
            fetchStatusData();
            refreshCalendarEvents();
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        showModal("error", `เกิดข้อผิดพลาด: ${error.message}`);
    }
});


        // --- INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", () => {
  fetchEquipmentList();

  // ✅ ใช้ flatpickr ที่เรียก calculateCost เมื่อเปลี่ยนวัน
  flatpickr("#startDate", {
    dateFormat: "Y-m-d",
    locale: "th",
    minDate: "today",
    onChange: calculateCost
  });

  flatpickr("#endDate", {
    dateFormat: "Y-m-d",
    locale: "th",
    minDate: "today",
    onChange: calculateCost
  });

  fetchStatusData();
  initializeCalendar();
  equipmentSelect.addEventListener("change", calculateCost);

});


        refreshBtn.addEventListener("click", () => {
            fetchStatusData();
            refreshCalendarEvents();
        });
        equipmentSelect.addEventListener("change", updateImagePreview);

        document.getElementById('upload-slip-btn').addEventListener('click', () => {
    document.getElementById('slip-modal').classList.add('active');
});

const slipInput = document.getElementById('slip-upload');
const slipPreview = document.getElementById('slip-preview');
const submitSlipBtn = document.getElementById('submit-slip-btn');
const loaderSmall = submitSlipBtn.querySelector('.loader-small');
const btnText = submitSlipBtn.querySelector('.btn-text');

slipInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        slipPreview.src = URL.createObjectURL(file);
        slipPreview.classList.remove('hidden');
        submitSlipBtn.disabled = false;
    }
});

document.getElementById('slip-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const file = slipInput.files[0];
    if (!file) return;

    btnText.textContent = "กำลังอัปโหลด...";
    loaderSmall.classList.remove('hidden');
    submitSlipBtn.disabled = true;

    const slipFormData = new FormData();
    slipFormData.append('action', 'uploadSlip');
    slipFormData.append('file', file);

    try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: slipFormData });
        const result = await response.json();
        if (result.result === 'success') {
            alert('อัปโหลดสลิปสำเร็จ ✅');
            document.getElementById('slip-modal').classList.remove('active');
        } else {
            alert('เกิดข้อผิดพลาด: ' + result.message);
        }
    } catch (err) {
        alert('อัปโหลดไม่สำเร็จ');
    } finally {
        btnText.textContent = "ยืนยัน";
        loaderSmall.classList.add('hidden');
        submitSlipBtn.disabled = false;
    }
});

// ✅ รีเฟรชสถานะการเช่าทุก 60 วินาที
setInterval(() => {
    fetchStatusData();
    refreshCalendarEvents();
}, 60000);

// ✅ โหลดรายการอุปกรณ์พร้อมรูป
async function fetchEquipmentList() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getEquipment`);
    equipmentDataStore = await res.json();
    equipmentSelect.innerHTML = '<option value="">-- เลือกอุปกรณ์ --</option>';
    equipmentDataStore.forEach(eq => {
      const opt = document.createElement("option");
      opt.value = eq.name;
      opt.textContent = `${eq.name} (${eq.price} บาท/วัน)`;
      equipmentSelect.appendChild(opt);
    });
  } catch (err) {
    equipmentSelect.innerHTML = '<option value="">โหลดไม่สำเร็จ</option>';
  }
}

// ✅ แสดงรูปตัวอย่างเมื่อเลือกอุปกรณ์
equipmentSelect.addEventListener("change", () => {
  const selected = equipmentDataStore.find(i => i.name === equipmentSelect.value);
  selectedEquipment = selected || null;
  if (selected && selected.imageUrl) {
    imagePreview.innerHTML = `<img src="${selected.imageUrl}" class="w-16 h-16 object-cover rounded">`;
  } else {
    imagePreview.innerHTML = `<div class="w-16 h-16 bg-gray-700 flex items-center justify-center text-gray-400"><i class="fas fa-image text-xl"></i></div>`;
  }
});

// ✅ คำนวณยอดรวม (เวอร์ชันใหม่)
function calculateCost() {
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  const selectedName = document.getElementById("equipmentName").value;

  const selected = equipmentDataStore.find(item => item.name === selectedName);
  if (!selected || !startDate || !endDate) {
    totalCostContainer.classList.add("hidden");
    totalCostDisplay.textContent = "฿0.00";
    return;
  }

  const start = new Date(startDate);
  const end = new Date(endDate);
  let days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
  if (days <= 0) days = 1;

  const pricePerDay = parseFloat(selected.price) || 0;
  const total = days * pricePerDay;

  totalCostDisplay.textContent = `฿${total.toFixed(2)}`;
  totalCostContainer.classList.remove("hidden");
}

equipmentSelect.addEventListener("change", calculateCost);

// ✅ ฟังก์ชันแสดง QR พร้อมเพย์
function showPromptPayModal(amount) {
  const qrURL = `https://promptpay.io/${PROMPTPAY_ID}/${amount}`;
  document.getElementById("promptpay-qr").src = qrURL;
  document.getElementById("promptpay-amount").textContent = amount.toFixed(2);
  document.getElementById("promptpay-modal").classList.add("active");
}

/// ✅ ฟังก์ชันยืนยันก่อนเช่าจริงและส่งต่อไป payment.html
rentalForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!confirm("คุณต้องการยืนยันการเช่าจริงหรือไม่?")) return;

  const formData = new FormData(rentalForm);
  const start = new Date(formData.get("startDate"));
  const end = new Date(formData.get("endDate"));

  if (end <= start) {
    alert("วันที่สิ้นสุดต้องอยู่หลังวันที่เริ่มเช่า");
    return;
  }

  try {
    // ✅ บันทึกข้อมูลลง Google Sheet ก่อน
    const res = await fetch(SCRIPT_URL, { method: "POST", body: formData });
    const result = await res.json();

    if (result.result === "success") {
      const total = parseFloat(totalCostDisplay.textContent.replace(/[฿,]/g, "")) || 0;
      const renterName = formData.get("renterName");
      const equipment = formData.get("equipmentName");
      const email = formData.get("email");

      // ✅ ส่งต่อไปหน้า payment.html พร้อมข้อมูลครบ
      window.location.href = `payment.html?name=${encodeURIComponent(renterName)}&equipment=${encodeURIComponent(equipment)}&amount=${encodeURIComponent(total)}&email=${encodeURIComponent(email)}`;
    } else {
      alert("เกิดข้อผิดพลาด: " + result.message);
    }
  } catch (err) {
    alert("ส่งข้อมูลไม่สำเร็จ: " + err.message);
  }
});


// ✅ ฟังก์ชันแนบสลิปหลังโอน
document.getElementById("upload-slip-btn").addEventListener("click", () => {
  document.getElementById("slip-modal").classList.add("active");
});

document.getElementById("slip-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const file = document.getElementById("slip-upload").files[0];
  if (!file) return alert("กรุณาเลือกไฟล์สลิป");

  const formData = new FormData();
  formData.append("action", "uploadSlip");
  formData.append("file", file);

  try {
    const res = await fetch(SCRIPT_URL, { method: "POST", body: formData });
    const result = await res.json();
    if (result.success || result.result === "success") {
      alert("อัปโหลดสลิปสำเร็จ ✅");
      document.getElementById("slip-modal").classList.remove("active");
    } else {
      alert("เกิดข้อผิดพลาด: " + result.message);
    }
  } catch (err) {
    alert("อัปโหลดไม่สำเร็จ: " + err.message);
  }
});

// ✅ เริ่มต้น
document.addEventListener("DOMContentLoaded", () => {
  fetchEquipmentList();
  flatpickr("#startDate", { dateFormat: "Y-m-d", locale: "th", minDate: "today", onChange: calculateCost });
  flatpickr("#endDate", { dateFormat: "Y-m-d", locale: "th", minDate: "today", onChange: calculateCost });
});
    </script>
   

</body>

</html>